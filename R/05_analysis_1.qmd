---
title: "05_analysis_1"
format: html
editor: visual
---

# Data Analysis

Creation of the big plot - figure 2:

The CI of the different treatments looking at different subgroups in the data. Pay note that some of the groups are represented by a 95% CI and others has a 99% CI. The 99% CI is used for all the subgroups, while the 95% CI is for the main group. Size of square refer to the amount of available information (the sample size).

![](images/clipboard-1327647554.png)

## Loading libraries

```{r}
library("tidyverse")
```

## Loading data

```{r}
data <- read_tsv("../data/03_dat_aug.tsv")
```

## Heparin vs. Control Subgroup Analysis

### Data augmentation - Creating the desired subgroups

```{r}
data_slim <- data |>
  mutate("Heparin" = case_when(
    RXHEP == 'L' ~ 'Y',
    RXHEP == 'M' ~ 'Y',
    RXHEP == 'N' ~ 'N',
    is.na(RXHEP) ~ NA)) |>
  mutate("Outcome" = case_when(
    OCCODE == "dead" ~ "dead/dependent",
    OCCODE == "dependent" ~ "dead/dependent",
    OCCODE == "not recovered" ~ "independent",
    OCCODE == "recovered" ~ "independent",
    is.na(OCCODE) ~ NA
  )) |> 
  mutate("RDELAY_group" = case_when(
    RDELAY <= 8 ~ "0-8h",
    RDELAY <= 12 ~ "9-12h",
    RDELAY <= 24 ~ "13-24h",
    RDELAY <= 48 ~ "25-48h",
    TRUE ~ NA)) |> 
  mutate("AGE_group" = case_when(
    AGE <= 75 ~ "≤75",
    AGE > 75 ~ ">75"
  )) |> 
  mutate("RSBP_group" = case_when(
    RSBP <= 180 ~ "≤180",
    RSBP > 180 ~ ">180")) |> 
  mutate("EXPDD_group" = case_when(
    EXPDD <= 0.4 ~ "0-40%",
    EXPDD <= 0.65 ~ "40-65%",
    EXPDD <= 0.90 ~ "65-90%",
    EXPDD <= 1 ~ "90-100%")) |> 
  select(Heparin,Outcome,RXASP,RDELAY_group,SEX,AGE_group,RSLEEP,RCONSC,RATRIAL,RSBP_group,STYPE,RDEF3,RCT,RVISINF,DDIAG,RASP3,RHEP24,EXPDD_group)
```

### Data augmentation - Calculating the statistics used in the plot

```{r}
data_nested <- data_slim |> 
  pivot_longer(cols = -c(Heparin,Outcome), names_to = "group", values_to = "subgroup") |>
  drop_na() |> 
  group_by(Heparin,Outcome,group,subgroup) |> 
  count() |> 
  mutate(n = n/1000) |> 
  group_by(group,subgroup) |> 
  nest() |> 
  ungroup()
```

```{r}
data_statistics <- data_nested |>
    mutate(data = map(.x = data, 
                      .f = ~ .x |> 
                        pivot_wider(
                          names_from = Outcome,
                          values_from = n))) |> 
  mutate(Total_dead = map_dbl(.x = data,
                              .f = ~sum(.x |> pull(`dead/dependent`))),
         Total_patients = map_dbl(.x = data,
                                  .f = ~sum(.x |> pull(`dead/dependent`))+sum(.x |> pull(independent))),
         Dead_rate = Total_dead / Total_patients) |> 
  mutate(data = map2(.x = data,
                     .y = Dead_rate,
                     .f = ~ .x |>
                       mutate(Expected_deaths = .y*(`dead/dependent`+independent)))) |>
  mutate(E = map_dbl(.x = data,
                     .f = ~ .x |>
                       select(Heparin,Expected_deaths) |> 
                       pivot_wider(
                         names_from = Heparin,
                         values_from = Expected_deaths) |>
                       mutate(difference = Y - N) |> 
                       pull(difference))) |> 
  mutate(O = map_dbl(.x = data,
                     .f = ~ .x |> 
                       select(Heparin,`dead/dependent`) |> 
                       pivot_wider(
                         names_from = Heparin,
                         values_from = `dead/dependent`) |>
                       mutate(difference = Y - N) |> 
                       pull(difference))) |> 
  mutate(V = map_dbl(.x = data,
                     .f = ~ .x |> 
                       mutate(inv_dead = 1/`dead/dependent`,
                              inv_alive = 1/independent) |> 
                       summarise(total = sum(inv_dead) + sum(inv_alive)) |>
                       pull(total)))
```

```{r}
k <- 0.207
alpha <- 0.99

data_CI <- data_statistics |> 
  mutate(Ad_ben = k*(O-E),
         std_dev = k*sqrt(V),
         CI_lower = Ad_ben - qnorm(alpha/2)*std_dev,
         CI_upper = Ad_ben + qnorm(alpha/2)*std_dev) |> 
  unite(group_name, c(group,subgroup))
```

### Data Illustration

First the group labels are created for the plot

```{r}
full_labels <-  c(
  "AGE_group_>75" = "Age >75", 
  "AGE_group_≤75" = "Age ≤75",
  "DDIAG_DDIAGHA" = "Final diagnosis: Haemorrhagic stroke",
  "DDIAG_DDIAGISC" = "Final diagnosis: Ischaemic stroke",
  "DDIAG_DDIAGUN" = "Final diagnosis: Indeterminate stroke",
  "DDIAG_DNOSTRK" = "Final diagnosis: Not a stroke",
  "EXPDD_group_0-40%" = "Predicted probability of death/dependence at 6 month: 0-40%",
  "EXPDD_group_40-65%" = "Predicted probability of death/dependence at 6 month: 40-65%",
  "EXPDD_group_65-90%" = "Predicted probability of death/dependence at 6 month: 65-90%",
  "EXPDD_group_90-100%" = "Predicted probability of death/dependence at 6 month: 90-100%",
  "RASP3_N" = "No aspirin within 3 days prior to randomisation",
  "RASP3_Y" = "Aspirin within 3 days prior to randomisation",
  "RHEP24_N" = "No heparin within 24 hours prior to randomisation",
  "RHEP24_Y" = "Heparin within 24 hours prior to randomisation",
  "RATRIAL_N" = "No atrial fibrillation",
  "RATRIAL_Y" = "Atrial fibrillation",
  "RCONSC_D" = "Drowsy state at randomisation",
  "RCONSC_F" = "Fully alert at randomisation",
  "RCONSC_U" = "Unconcious at randomisation",
  "RCT_N" = "No CT before randomisation",
  "RCT_Y" = "CT before randomisation",
  "RDEF3_N" = "No leg/foot deficit",
  "RDEF3_Y" = "Leg/foot deficit",
  "RDELAY_group_0-8h" = "0-8 hour delay between stroke and randomisation",
  "RDELAY_group_9-12h" = "9-12 hour delay between stroke and randomisation",
  "RDELAY_group_13-24h" = "13-24 hour delay between stroke and randomisation",
  "RDELAY_group_25-48h" = "25-48 hour delay between stroke and randomisation",
  "RSBP_group_≤180" = "Systolic blood pressure under 180mmHg at randomisation",
  "RSBP_group_>180" = "Systolic blood pressure over 180mmHg at randomisation",
  "RSLEEP_N" = "Symptoms appearing while awake",
  "RSLEEP_Y" = "Symptoms appearing while asleep",
  "RVISINF_N" = "No infarct visible on CT",
  "RVISINF_Y" = "Infarct visible on CT",
  "RXASP_N" = "No trial aspirin allocated",
  "RXASP_Y" = "Trial aspirin allocated",
  "SEX_F" = "Female",
  "SEX_M" = "Male",
  "STYPE_LACS" = "Stroke subtype: Lacunar syndrome",
  "STYPE_PACS" = "Stroke subtype: Partial anterior circulation syndrome",
  "STYPE_POCS" = "Stroke subtype: Posterior circulation syndrome",
  "STYPE_TACS" = "Stroke subtype: Total anterior circulation syndrome",
  "STYPE_OTH" = "Stroke subtype: Other")
```

The plot is created similarly to the figure 2 in the data

```{r}
p1 <- data_CI |> 
  ggplot(aes(x = Ad_ben,
             y = group_name,
             xmin = CI_lower,
             xmax = CI_upper))+
  geom_point(aes(size = Total_patients),shape = 15)+
  geom_errorbarh(color = "blue")+
  geom_vline(xintercept = 0, color = "grey", linetype = 2)+
  scale_y_discrete(labels = full_labels)+
  scale_size_continuous(range = c(1,3))+
  labs(x = "Reductions in odds of being dead or dependent at six months for heparin versus no heparin",
       size = "Group size (in 1000 patients)")+
  theme_minimal()+
  theme(axis.title.y = element_blank(),
        legend.position = "bottom")

p1
```
