---
title: "08_analysis_4"
author: "Group 29"
format: html
editor: visual
---

## Data analysis

## Effects subdivided by heparin and aspirin

Allocation on:

absolute risk of symptomatic intracranial haemorrhage;

absolute risk of transfused or fatal extracranial haemorrhage;

absolute risk of recurrent ischaemic stroke;

absolute risk of pulmonary embolism reported (with possibility of substantial under-reporting)

Error bars plot one standard error for percentage. For each bar, lower part gives number and percentage of fatal events.

![](images/clipboard-3768980609.png){width="557"}

```{r}
data <- data_clean_properDEADcode
```

```{r}
data |> 
  group_by(H14) |> 
  count()
```

```{r}
data |> 
  select(DLH14, DMH14) |> 
  count()
  
  
```

```{r}
data_2 <- data |> 
  mutate(DH14 = case_when(
    DLH14 == "N" & DMH14 == "N" ~ "C",
    DLH14 == "Y" & DMH14 == "N" ~ "L",
    DLH14 == "N" & DMH14 == "Y" ~ "M"))
```

```{r}
data_2 |> 
  select(DH14) |> 
  group_by(DH14) |> 
  count()
```

```{r}
data_2 |> 
  mutate(across(DASP14, ~na_if(., "U")),
         DASP14 = if_else(DASP14 == "y", "Y", DASP14),
         DASP14 = if_else(DASP14 == "n", "N", DASP14)) |> 
  group_by(DH14, DASP14) |> 
  count()
```

```{r}
data_2 |> 
  group_by(DH14, RXASP) |> 
  count()
```

```{r}
data_2 |> 
  group_by(DH14, RXASP) |> 
  count() |> 
  ggplot(aes(x = DH14, y = n, fill = RXASP)) +
  geom_col(position = position_dodge(preserve = "single"))
```

```{r}
data_3 <- data_2 |> 
  select(DH14, RXASP, DRSH) |> 
  mutate(across(DRSH, ~na_if(., "U")))
```

```{r}
data_4 <- data_3 |> 
  group_by(DH14, RXASP, DRSH) |> 
  filter(!is.na(DRSH)) |> 
  count()

data_4
```

```{r}
data_5 <- data_4 |> 
  group_by(DH14, RXASP) |> 
  mutate(total_in_group = sum(n),
         percentage = ifelse(DRSH == "Y", n / total_in_group * 100, 0)) |> 
  filter(DRSH != "N") |> 
  mutate(DH14 = factor(DH14, levels = c("M", "L", "C")),
         RXASP = factor(RXASP, levels = c("Y", "N")))
  
data_5
```

```{r}
data_5 |>   
  ggplot(aes(x = DH14, y = percentage, fill = RXASP)) +
  geom_col(position = position_dodge(preserve = "single"),
           alpha = 0.7,
           color = "black") +
  geom_text(aes(label = round(percentage, 2)),
            position = position_dodge(width = 0.9),
            vjust = -0.5,
            size = 3) +
  labs(title = "Percentage of patients with recurrent Haemorrhagic stroke after 14 days",
       subtitle = "These numbers are from second consultation 14 days after randomisation",
       x = NULL,
       y = "%",
       fill = "Aspirin Dosing") +
  scale_fill_brewer(palette = "Dark2",
                    labels = c("Y" = "300 mg daily",
                                 "N" = "No Aspirin")) +
  theme_minimal() +
  theme(legend.position = "bottom",
        axis.title.y = element_text(angle = 0, vjust = 0.5),
        panel.grid.major.x = element_blank()) +
  scale_x_discrete(labels = c("M" = "12500 IU Heparin",
                              "L" = "5000 IU Heparin",
                              "C" = "No Heparin"))
```
