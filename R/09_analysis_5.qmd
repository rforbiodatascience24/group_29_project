---
title: "09_analysis_5"
author: "Group 29: Helena Møller, Emma Christensen, Frederik Holmstrup, Casper Harreby & Laura Christiansen"
format: html
---

# Data analysis - visualising the overall effect of the treatments

## Loading libraries

```{r}
library("tidyverse")
library("survival")
library(RColorBrewer)
```

## Loading data

```{r}
data <- read_tsv("../data/03_dat_aug.tsv")
```

## Preparing data for plot

To asses the overall impact of the different treatment groups, the data is prepared for a Kaplan-Meier curve of the data and a Cox proportional hazards model

A Kaplan-Meier curve is a curve illustrating the overall survival rate for each group over time. We can plot it for 0-6 months after randomization. We can use this to see if there is an overall difference in survival for the treatments over time. For this we need a time-of-death (if one) and group value for each subject.

```{r}
data_filtered <- data |> 
  select(TD,FDEAD,data_group) |> 
  mutate(FDEAD = recode(FDEAD, "Y" = 1, "N" = 0)) |> 
  mutate(TD = if_else(TD > 183, 183, TD))
```

```{r}
km_fit <- survfit(Surv(TD, FDEAD) ~ data_group, data = data_filtered)
km_tidy <- broom::tidy(km_fit)
```

```{r}
p1 <- km_tidy |>
  mutate(strata = str_remove(strata,"data_group=")) |> 
  ggplot(mapping = aes(x = time, 
                       y = estimate, 
                       color = strata)) + # `strata` is the name of the groups from the km model
  geom_step(linewidth = 1) +                           # Kaplan-Meier steps
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), 
              alpha = 0.1, linetype = "dashed") +       # Confidence interval
  labs(
    title = "Kaplan-Meier Survival curve",
    x = "Time (days)",
    y = "Probability of survival",
    color = "Treatment group")+
  scale_color_brewer(palette="Dark2")+
  theme_minimal()
```

```{r}
# Plot HR fra Cox-model
cox_tidy |> 
  mutate(term = str_replace(term, "gruppe", "")) |>   # Fjern præfikset "gruppe"
  ggplot(aes(x = estimate, y = term)) +
  geom_point(size = 3, color = "blue") +
  #geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2) +  # CI
  labs(
    title = "Hazard Ratios fra Cox-modellen",
    x = "Hazard Ratio (log-skala)",
    y = "Gruppe"
  ) +
  scale_x_log10() +  # Log-skala for HR
  theme_minimal()

```
