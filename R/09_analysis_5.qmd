---
title: "09_analysis_5"
author: "Group 29: Helena MÃ¸ller, Emma Christensen, Frederik Holmstrup, Casper Harreby & Laura Christiansen"
format: html
execute: 
  message: FALSE
  warning: FALSE
---

# Data analysis - visualizing the overall effect of the treatments

## Loading libraries

```{r}
#| echo: true
#| eval: true

library("tidyverse")
library("here")
library("survival")
library("RColorBrewer")
library("broom")
```

```{r}
source(here("R/99_proj_func.R"))
```

## Loading data

```{r}
data <- read_tsv(here("data/03_dat_aug.tsv"))
```

## Preparing data for plot

A Kaplan-Meier curve is a curve illustrating the overall survival rate for each group over time. We can plot it for 0-6 months after randomization. We can use this to see if there is an overall difference in survival for the treatments over time. For this we need a time-of-death (if one) and group value for each subject.

A Chi-squared test is a statistical test to see of there is a significant difference in group sizes. The null-hypothesis would be that for all types of treatments, there is the same fraction of people which has died or are dependent after 6 months.

```{r}
data_filtered <- data |> 
  select(TD,FDEAD,data_group) |> 
  mutate(FDEAD = recode(FDEAD, "Y" = 1, "N" = 0)) |> 
  mutate(TD = if_else(TD > 183, 183, TD))

data_filtered_group <- data_filtered |> 
  select(data_group,FDEAD) |> 
  filter(!is.na(FDEAD)) |> 
  group_by(data_group,FDEAD) |> 
  count()

data_filtered_chisqr <- data_filtered_group |> 
  pivot_wider(names_from = data_group, values_from = n) |> 
  column_to_rownames(var = "FDEAD")

data_filtered_barchart <- data_filtered_group |> 
  group_by(data_group) |> 
  summarize(sum = sum(n),
            fraction = sum(n * (FDEAD == 1))/sum) |> 
  mutate(data_name = str_glue("{data_group}(n = {sum})"))

data_filtered_chisqr <- data_filtered |> 
  select(data_group,FDEAD) |> 
  filter(!is.na(FDEAD)) |> 
  group_by(data_group,FDEAD) |> 
  count() |> 
  pivot_wider(names_from = data_group, values_from = n) |> 
  column_to_rownames(var = "FDEAD")

group_combinations <- data_filtered |> 
  expand(data_group,data_group)
```

```{r}
km_fit <- survfit(Surv(TD, FDEAD) ~ data_group, data = data_filtered)
km_tidy <- broom::tidy(km_fit)

chi_sqr_test <- group_combinations |> 
  mutate(chisqr_pval = 
           map2_dbl(.x = data_group...1,
                    .y = data_group...2,
                    .f = ~ chisqr_pval(data_filtered_chisqr, c(.x, .y)))) |> 
  mutate(chisqr_pval = if_else(data_group...1 == data_group...2, 1, chisqr_pval ))
```

```{r}
p1 <- km_tidy|>
  mutate(strata = str_remove(strata,"data_group=")) |> 
  ggplot(mapping = aes(x = time, 
                       y = estimate, 
                       color = strata)) + # `strata` is the name of the groups from the km model
  geom_step(linewidth = 1) +                           # Kaplan-Meier steps
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), 
              alpha = 0.1, linetype = "dashed") +       # Confidence interval
  labs(
    title = "Kaplan-Meier Survival curve",
    x = "Time (days)",
    y = "Probability of survival",
    color = "Treatment group")+
  scale_color_brewer(palette="Dark2")+
  theme_minimal()

p1
```

```{r}
# Plot tiles where color correspond to the pvalues

p2 <- chi_sqr_test |> 
        ggplot(mapping = aes(x = data_group...1,
                             y = data_group...2,
                             fill = chisqr_pval))+
        geom_tile()+
        scale_fill_gradient2(
          low = "#1B9E77",
          mid = "white",
          high = "#7570B3",
          midpoint = 0.05)+
        theme_minimal()+
        theme(axis.title = element_blank(),
              axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

p2
```

## Save the results

```{r}
ggsave(filename = here("results/09_keyplot_5a.png"), plot = p1, width = 8, height = 4, dpi = 300, bg = "white")  
ggsave(filename = here("results/09_keyplot_5b.png"), plot = p2, width = 8, height = 4, dpi = 300, bg = "white")  
```
